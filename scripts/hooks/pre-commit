#!/bin/bash

# Cloud Code Agents - Pre-commit Hook
# ã“ã®ãƒ•ãƒƒã‚¯ã¯ã€ã‚³ãƒŸãƒƒãƒˆå‰ã«è‡ªå‹•çš„ã«lintã¨fmtã‚’å®Ÿè¡Œã—ã¾ã™

set -e

echo "ğŸ” Running pre-commit hooks..."

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd "$(git rev-parse --show-toplevel)"

# Makefileã®å­˜åœ¨ç¢ºèª
if [ ! -f "Makefile" ]; then
    echo "âŒ Error: Makefile not found in project root"
    echo "   This pre-commit hook requires a Makefile with 'lint' and 'fmt' targets"
    exit 1
fi

# make lintã¨make fmtã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®å­˜åœ¨ç¢ºèª
if ! make -n lint >/dev/null 2>&1; then
    echo "âŒ Error: 'make lint' target not found in Makefile"
    echo "   Please ensure your Makefile includes a 'lint' target"
    exit 1
fi

if ! make -n fmt >/dev/null 2>&1; then
    echo "âŒ Error: 'make fmt' target not found in Makefile"
    echo "   Please ensure your Makefile includes a 'fmt' target"
    exit 1
fi

echo "ğŸ¨ Running code formatter..."

# make fmtã‚’å®Ÿè¡Œ
if ! make fmt; then
    echo "âŒ Error: Code formatting failed"
    echo "   Please fix formatting issues and try again"
    exit 1
fi

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¾Œã«å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if ! git diff --quiet; then
    echo "ğŸ“ Code formatting made changes to the following files:"
    git diff --name-only
    echo ""
    echo "âœ… Automatically staging formatted files..."
    
    # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•çš„ã«stageã«è¿½åŠ 
    git add -u
    
    echo "âœ… Formatted files have been staged"
fi

echo "ğŸ” Running linter..."

# make lintã‚’å®Ÿè¡Œ
if ! make lint; then
    echo ""
    echo "âŒ Commit aborted: Linting failed"
    echo ""
    echo "Please fix the linting errors above and try committing again."
    echo "You can run 'make lint' to see the specific issues."
    echo ""
    exit 1
fi

echo "âœ… All pre-commit checks passed!"
echo "âœ… Proceeding with commit..."

exit 0