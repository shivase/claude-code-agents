package main

import (
	"fmt"
	"os"
	"path/filepath"
	"strings"
)

// generateConfigCommand è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰
func generateConfigCommand(force bool) error {
	fmt.Println("ğŸ”§ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ")
	fmt.Println("===================")
	
	// è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆãƒ‘ã‚¹ã‚’å–å¾—
	configPath := GetTeamConfigPath()
	
	// è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
	configDir := filepath.Dir(configPath)
	if err := os.MkdirAll(configDir, 0755); err != nil {
		return fmt.Errorf("è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: %v", err)
	}
	
	// æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
	if _, err := os.Stat(configPath); err == nil && !force {
		fmt.Printf("âš ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™: %s\n", configPath)
		fmt.Println("æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãã™ã‚‹ã«ã¯ --force ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚")
		fmt.Println("")
		fmt.Println("ä½¿ç”¨ä¾‹:")
		fmt.Println("  ./claude-code-agents --generate-config --force")
		return fmt.Errorf("è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™")
	}
	
	// è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç”Ÿæˆ
	template := generateConfigTemplate()
	
	// ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãè¾¼ã¿
	if err := os.WriteFile(configPath, []byte(template), 0644); err != nil {
		return fmt.Errorf("è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: %v", err)
	}
	
	fmt.Printf("âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸ: %s\n", configPath)
	fmt.Println("")
	fmt.Println("ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹:")
	fmt.Println("   - 33é …ç›®ã®è¨­å®šé …ç›®")
	fmt.Println("   - 6ã‚«ãƒ†ã‚´ãƒªã®åˆ†é¡")
	fmt.Println("   - é©åˆ‡ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤")
	fmt.Println("   - è©³ç´°ãªã‚³ãƒ¡ãƒ³ãƒˆ")
	fmt.Println("")
	fmt.Println("ğŸ“ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ã€ç’°å¢ƒã«åˆã‚ã›ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ãã ã•ã„ã€‚")
	fmt.Println("   ç·¨é›†å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã§ãã¾ã™:")
	fmt.Printf("   ./claude-code-agents <ã‚»ãƒƒã‚·ãƒ§ãƒ³å>\n")
	
	return nil
}

// generateConfigTemplate è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç”Ÿæˆ
func generateConfigTemplate() string {
	homeDir, _ := os.UserHomeDir()
	claudeDir := filepath.Join(homeDir, ".claude")
	cloudCodeAgentsDir := filepath.Join(claudeDir, "cloud-code-agents")
	
	var template strings.Builder
	
	// ãƒ˜ãƒƒãƒ€ãƒ¼
	template.WriteString("# AI Teams System Configuration File\n")
	template.WriteString("# Generated by claude-code-agents --generate-config\n")
	template.WriteString("# Edit this file to customize your AI teams system\n")
	template.WriteString("\n")
	
	// Path Configuration
	template.WriteString("# ==========================================\n")
	template.WriteString("# Path Configuration\n")
	template.WriteString("# ==========================================\n")
	template.WriteString("\n")
	template.WriteString("# Claude CLI executable path\n")
	template.WriteString(fmt.Sprintf("CLAUDE_CLI_PATH=%s\n", filepath.Join(claudeDir, "local", "claude")))
	template.WriteString("\n")
	template.WriteString("# Instructions directory for AI agents\n")
	template.WriteString(fmt.Sprintf("INSTRUCTIONS_DIR=%s\n", filepath.Join(cloudCodeAgentsDir, "instructions")))
	template.WriteString("\n")
	template.WriteString("# Working directory for AI teams\n")
	template.WriteString("WORKING_DIR=.\n")
	template.WriteString("\n")
	template.WriteString("# Configuration directory\n")
	template.WriteString(fmt.Sprintf("CONFIG_DIR=%s\n", cloudCodeAgentsDir))
	template.WriteString("\n")
	template.WriteString("# Log file path\n")
	template.WriteString(fmt.Sprintf("LOG_FILE=%s\n", filepath.Join(cloudCodeAgentsDir, "logs", "manager.log")))
	template.WriteString("\n")
	template.WriteString("# Authentication backup directory\n")
	template.WriteString(fmt.Sprintf("AUTH_BACKUP_DIR=%s\n", filepath.Join(cloudCodeAgentsDir, "auth_backup")))
	template.WriteString("\n")
	
	// System Settings
	template.WriteString("# ==========================================\n")
	template.WriteString("# System Settings\n")
	template.WriteString("# ==========================================\n")
	template.WriteString("\n")
	template.WriteString("# Maximum number of concurrent processes\n")
	template.WriteString("MAX_PROCESSES=4\n")
	template.WriteString("\n")
	template.WriteString("# Maximum memory usage in MB\n")
	template.WriteString("MAX_MEMORY_MB=1024\n")
	template.WriteString("\n")
	template.WriteString("# Maximum CPU usage percentage\n")
	template.WriteString("MAX_CPU_PERCENT=80.0\n")
	template.WriteString("\n")
	template.WriteString("# Log level (debug, info, warn, error)\n")
	template.WriteString("LOG_LEVEL=info\n")
	template.WriteString("\n")
	template.WriteString("# Health check interval\n")
	template.WriteString("HEALTH_CHECK_INTERVAL=30s\n")
	template.WriteString("\n")
	template.WriteString("# Maximum restart attempts\n")
	template.WriteString("MAX_RESTART_ATTEMPTS=3\n")
	template.WriteString("\n")
	
	// Tmux Settings
	template.WriteString("# ==========================================\n")
	template.WriteString("# Tmux Settings\n")
	template.WriteString("# ==========================================\n")
	template.WriteString("\n")
	template.WriteString("# Default session name\n")
	template.WriteString("SESSION_NAME=ai-teams\n")
	template.WriteString("\n")
	template.WriteString("# Default layout (integrated, individual)\n")
	template.WriteString("DEFAULT_LAYOUT=integrated\n")
	template.WriteString("\n")
	template.WriteString("# Auto attach to session\n")
	template.WriteString("AUTO_ATTACH=false\n")
	template.WriteString("\n")
	template.WriteString("# Number of panes in integrated layout\n")
	template.WriteString("PANE_COUNT=6\n")
	template.WriteString("\n")
	
	// Authentication Settings
	template.WriteString("# ==========================================\n")
	template.WriteString("# Authentication Settings\n")
	template.WriteString("# ==========================================\n")
	template.WriteString("\n")
	template.WriteString("# Authentication check interval\n")
	template.WriteString("AUTH_CHECK_INTERVAL=30m\n")
	template.WriteString("\n")
	template.WriteString("# Enable IDE backup\n")
	template.WriteString("IDE_BACKUP_ENABLED=true\n")
	template.WriteString("\n")
	
	// Performance Settings
	template.WriteString("# ==========================================\n")
	template.WriteString("# Performance Settings\n")
	template.WriteString("# ==========================================\n")
	template.WriteString("\n")
	template.WriteString("# System startup timeout\n")
	template.WriteString("STARTUP_TIMEOUT=10s\n")
	template.WriteString("\n")
	template.WriteString("# System shutdown timeout\n")
	template.WriteString("SHUTDOWN_TIMEOUT=15s\n")
	template.WriteString("\n")
	template.WriteString("# Process restart delay\n")
	template.WriteString("RESTART_DELAY=5s\n")
	template.WriteString("\n")
	template.WriteString("# Process timeout\n")
	template.WriteString("PROCESS_TIMEOUT=30s\n")
	template.WriteString("\n")
	
	// Command Names
	template.WriteString("# ==========================================\n")
	template.WriteString("# Command Names\n")
	template.WriteString("# ==========================================\n")
	template.WriteString("\n")
	template.WriteString("# Send agent command name\n")
	template.WriteString("SEND_COMMAND=send-agent\n")
	template.WriteString("\n")
	template.WriteString("# Binary name\n")
	template.WriteString("BINARY_NAME=claude-code-agents\n")
	template.WriteString("\n")
	
	// ãƒ•ãƒƒã‚¿ãƒ¼
	template.WriteString("# ==========================================\n")
	template.WriteString("# End of Configuration\n")
	template.WriteString("# ==========================================\n")
	template.WriteString("# For more information, see the documentation\n")
	template.WriteString("# or run: ./claude-code-agents --help\n")
	
	return template.String()
}