# Goè¨€èªç‰ˆClaude CLIç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

# å¤‰æ•°å®šç¾©
GO_VERSION := 1.21
BINARY_NAME := claude-code-agents
BUILD_DIR := build
INSTALL_DIR=/usr/local/bin
PACKAGE_NAME := claude-code-agents

# ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œ
GOOS := $(shell go env GOOS)
GOARCH := $(shell go env GOARCH)

# ãƒ“ãƒ«ãƒ‰ãƒ•ãƒ©ã‚°
LDFLAGS := -s -w

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
.PHONY: all
all: build

# ä¾å­˜é–¢ä¿‚ã®å–å¾—
.PHONY: deps
deps:
	go mod tidy
	go mod download

# ãƒ“ãƒ«ãƒ‰
.PHONY: build
build: deps
	@echo "ğŸ”¨ Building $(BINARY_NAME) for $(GOOS)/$(GOARCH)..."
	@mkdir -p $(BUILD_DIR)
	CGO_ENABLED=0 GOOS=$(GOOS) GOARCH=$(GOARCH) go build -o $(BUILD_DIR)/$(BINARY_NAME) -ldflags="$(LDFLAGS)" *.go
	@echo "âœ… Build completed: $(BUILD_DIR)/$(BINARY_NAME)"

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
.PHONY: install
install: build
	@echo "ğŸ“¦ Installing binaries to $(INSTALL_DIR)..."
	@mkdir -p $(INSTALL_DIR)
	sudo rm $(INSTALL_DIR)/$(BINARY_NAME)
	sudo cp $(BUILD_DIR)/$(BINARY_NAME) $(INSTALL_DIR)/
	sudo chmod +x $(INSTALL_DIR)/$(BINARY_NAME)

# ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
.PHONY: uninstall
uninstall:
	@echo "ğŸ—‘ï¸  Uninstalling binaries..."
	@rm -f $(INSTALL_DIR)/$(BINARY_NAME)
	@echo "âœ… Uninstallation completed"

# ãƒ†ã‚¹ãƒˆ
.PHONY: test
test:
	@echo "ğŸ§ª Running tests..."
	go test -p 1 -v -timeout=10m -count=1 ./test/...

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆå®Ÿè¡Œ
.PHONY: test-coverage
test-coverage:
	@echo "ğŸ“Š Running tests with coverage..."
	go test -v -race -coverprofile=coverage.out -covermode=atomic ./test/...
	go tool cover -html=coverage.out -o coverage.html
	@echo "ğŸ“„ Coverage report generated: coverage.html"

# ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯
.PHONY: test-coverage-check
test-coverage-check:
	@echo "ğŸ¯ Checking coverage thresholds..."
	go test -coverprofile=coverage.out ./test/...
	@go tool cover -func=coverage.out | grep "total:" | awk '{if($$3+0 < 75.0) {print "âŒ Coverage below 75%: " $$3; exit 1} else {print "âœ… Coverage above 75%: " $$3}}'

.PHONY: lint
lint:
	@echo "ğŸ” Running linters..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run internal/... --config .golangci.yaml; \
		golangci-lint run test/... --config .golangci.yaml; \
	else \
		echo "âš ï¸  golangci-lint not found, running go vet instead"; \
		go vet ./...; \
	fi

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
.PHONY: fmt
fmt:
	@echo "ğŸ¨ Formatting code..."
	go fmt ./...

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
.PHONY: clean
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf $(BUILD_DIR)
	go clean -cache
	go clean -modcache
	@echo "âœ… Cleanup completed"

# ãƒ˜ãƒ«ãƒ—
.PHONY: help
help:
	@echo "ğŸ¤– Claude Code Agents - Go Implementation"
	@echo ""
	@echo "Available targets:"
	@echo "  build              - Build the main binary for current platform"
	@echo "  install            - Install binaries to $(INSTALL_DIR)"
	@echo "  uninstall          - Remove installed binaries"
	@echo "  test               - Run all tests"
	@echo "  test-ci            - Run tests in CI environment with mocks"
	@echo "  test-coverage      - Run tests with coverage and generate HTML report"
	@echo "  test-coverage-check- Check coverage meets 75% threshold"
	@echo "  lint               - Run static analysis"
	@echo "  fmt                - Format code"
	@echo "  clean              - Clean build artifacts and caches"
	@echo "  help               - Show this help message"
